#!/bin/bash
# This is the standard command to use when launching an ember server.  Note that
# the container's host is available at hostname `host` instead of `localhost`.
# eg:
#   eds
#   eds --proxy http://host:8080

VERSION="2.14.0"
UNMOUNTED_FILES=("tmp" ".editorconfig" "README.md")
EDI_AUTHORATIVE_FILES=("dist" "node_modules" "vendor" "bower_components")

if [ -r ~/.config/edi/settings ]
then
    . ~/.config/edi/settings
fi

# Allow overriding the edi version
if [ -n "$EDI_EMBER_VERSION" ]
then
    VERSION=$EDI_EMBER_VERSION
fi

linked_volumes=""
for file in `find ~/.local/lib/node_modules/ -maxdepth 1 -type l`
do
    name=`basename $file`
    real_target=`readlink $file`
    linked_volumes="$linked_volumes --volume $file:/usr/lib/node_modules/$name/ "
done

mounted_current_volumes=""
for file in `find . -maxdepth 1 -mindepth 1`
do
    name=`basename $file`
    if echo ${UNMOUNTED[@]} | grep -q -w "$name"; then
        echo "Not mounting $file"
    elif echo ``${EDI_AUTHORATIVE[@]} | grep -q -w "$name"; then
        mounted_current_volumes="$mounted_current_volumes --volume `pwd`/$file:/app/$name:delegated"
    else
        mounted_current_volumes="$mounted_current_volumes --volume `pwd`/$file:/app/$name:cached"
    fi
done

if [[ "$OSTYPE" == "linux-gnu" ]]; then
    # Linux
    DOCKERHOST=`ip addr show docker0 | grep inet | head -n 1 | awk '{ print $2 }' | grep -oP "^[^/]+"`
elif [[ "$OSTYPE" == "darwin"* ]]; then
    # Mac OSX
    # Solution found via https://stackoverflow.com/questions/24319662/from-inside-of-a-docker-container-how-do-i-connect-to-the-localhost-of-the-mach
    DOCKERHOST=$(ifconfig | grep -E "([0-9]{1,3}\.){3}[0-9]{1,3}" | grep -v 127.0.0.1 | awk '{ print $2 }' | cut -f2 -d: | head -n1)
fi

docker run --rm \
       $linked_volumes \
       $mounted_current_volumes \
       -p 4200:4200 \
       -p 49152:49152 \
       -p 49153:49153 \
       --add-host host:$DOCKERHOST \
       madnificent/ember:$VERSION ember serve $@
