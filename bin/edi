#!/bin/bash
# This is the command to use when running interactive commands
# eg:
#   edi ember release --minor
# see https://gist.github.com/d11wtq/8699521

VERSION="2.14.0"

if [ -r ~/.config/edi/settings ]
then
    . ~/.config/edi/settings
fi

# Allow overriding the edi version
if [ -n "$EDI_EMBER_VERSION" ]
then
    VERSION=$EDI_EMBER_VERSION
fi

linked_volumes=""
if [ -r $HOME/.local/lib/node_modules/ ]
then
    for file in `find $HOME/.local/lib/node_modules/ -maxdepth 1 -type l`
    do
        name=`basename $file`
        real_target=`readlink $file`
        linked_volumes="$linked_volumes --volume $file:/usr/lib/node_modules/$name/:delegated "
    done
fi

if [ "$(uname)" == "Darwin" ]
then
    CONTAINER_NAME="edi"
    SSH_AGENT_NAME="pinata-sshd"

    # start ssh agent, which forwards ssh-socket. Known bug in docker for mac: https://github.com/docker/for-mac/issues/410
    if [ ! "$(Docker ps -q -f name=$SSH_AGENT_NAME)" ]; then

        echo "Starting $SSH_AGENT_NAME"

        if [ "$(docker ps -aq -f status=exited -f name=$SSH_AGENT_NAME)" ]; then
            # cleanup
            docker rm $SSH_AGENT_NAME
        fi
        pinata-ssh-forward
        ssh-add
    fi


    # check if daemon container runs, if not start it (and clean eventual exited containers)
    # see https://stackoverflow.com/questions/38576337/execute-bash-command-if-docker-container-does-not-exist
    if [ ! "$(Docker ps -q -f name=$CONTAINER_NAME)" ]; then

        echo "Starting container named $CONTAINER_NAME"

        if [ "$(docker ps -aq -f status=exited -f name=$CONTAINER_NAME)" ]; then
            # cleanup
            docker rm $CONTAINER_NAME
        fi

        # run your container
        docker run -td --name $CONTAINER_NAME \
               $(pinata-ssh-mount) \
               --volume `pwd`:/app/:delegated \
               --volume /app/tmp \
               $linked_volumes \
               --volume $HOME/.gitconfig:/root/.gitconfig:delegated \
               madnificent/ember:$VERSION ;
    fi

    echo "Executing command $@ on $CONTAINER_NAME"
    docker exec -ti $CONTAINER_NAME $@

else

docker run --rm \
       -it \
       --volume `pwd`:/app/ \
       --volume /app/tmp \
       --volume $(dirname $SSH_AUTH_SOCK):$(dirname $SSH_AUTH_SOCK) \
       -e SSH_AUTH_SOCK=$SSH_AUTH_SOCK \
       $linked_volumes \
       --volume $HOME/.gitconfig:/root/.gitconfig \
       madnificent/ember:$VERSION $@

fi
